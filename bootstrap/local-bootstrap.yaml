# Run as local user you want to be able to remotely provision, needs sudo access

- name: Local Server Bootstrap
  hosts: localhost
  connection: local
  tasks:
  - name: Ensure Boot Strap Packages are present
    ansible.builtin.dnf:
      update_cache: yes
      name:
        - sshpass
        - openssh-server
      allowerasing: yes
      state: present

  - name: Ensure ssh directory exist
    ansible.builtin.file:
      path: "{{ ansible_user_dir }}/.ssh"
      state: directory
      mode: '0700'
      owner: "{{ localhost_user }}"
      group: "{{ localhost_user_group }}"

  - name: Ensure user account has ssh key pair generated
    community.crypto.openssh_keypair:
      path: "{{ ansible_user_dir }}/.ssh/id_rsa"
      owner: "{{ localhost_user }}"
      group: "{{ localhost_user_group }}"

  - name: Ensure sshd is enable and started
    ansible.builtin.systemd:
      name: sshd
      enabled: yes
      state: started

  - name: Ensure hostname is correct
    ansible.builtin.hostname:
      name: server0

  - name: Ensure logind.conf.d directory exists
    ansible.builtin.file:
      path: /etc/systemd/logind.conf.d
      state: directory
      owner: root
      group: root
      mode: '0755'

  - name: Ensure power settings are correct
    ansible.builtin.copy:
      src: files/power.conf
      dest: /etc/systemd/logind.conf.d/power.conf
      owner: root
      group: root
      mode: '0644'
    notify: Restart logind

  handlers:
    - name: Restart logind
      ansible.builtin.systemd:
        name: systemd-logind.service
        state: restarted